<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Block Blast - MINH HAI DEVELOPER</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: #2a2e4a;
      color: white;
      text-align: center;
      margin: 0;
      padding: 10px;
    }

    h1, h2 {
      margin: 5px 0;
    }

    #player-name {
      padding: 8px;
      margin: 10px 0;
      width: 90%;
      max-width: 300px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    #board {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 2px;
      max-width: 95vw;
      width: 320px;
      margin: 0 auto 20px;
    }

    .cell {
      aspect-ratio: 1/1;
      background-color: #6b7ac4;
      transition: background-color 0.3s, transform 0.4s ease;
    }

    .cell.filled {
      background-color: limegreen;
    }

    .cell.highlight {
      background-color: gold !important;
    }

    .cell.shrink {
      transform: scale(0);
    }

    #block-options {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 10px auto;
    }

    .block {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 2px;
      padding: 5px;
      cursor: pointer;
    }

    .block-cell {
      width: 20px;
      height: 20px;
      background-color: transparent;
    }

    .block-cell.filled {
      background-color: steelblue;
      border-radius: 3px;
    }

    .block.selected .block-cell.filled {
      outline: 2px solid orange;
    }

    button {
      background: #a17474;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      margin-top: 10px;
      border-radius: 5px;
      cursor: pointer;
    }

    #game-over {
      font-size: 22px;
      color: red;
      margin: 10px 0;
      display: none;
    }

    #leaderboard {
      margin-top: 30px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    #leaderboard h3 {
      color: gold;
    }

    #leaderboard ol {
      padding-left: 20px;
      text-align: left;
    }

    @media (max-width: 400px) {
      .block-cell {
        width: 16px;
        height: 16px;
      }

      #board {
        width: 280px;
      }

      .cell {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <h1 style="color: cyan;">Block Blast</h1>
  <h2 style="color: #ffaaaa;">MINH HAI DEVELOPER</h2>

  <input type="text" id="player-name" placeholder="Nhập tên bạn..." maxlength="20" />
  <div id="board"></div>
  <div id="block-options"></div>

  <h3>Score: <span id="score">0</span></h3>
  <div id="game-over">Game Over!</div>
  <button onclick="restartGame()">Restart</button>

  <div id="leaderboard">
    <h3>Bảng Xếp Hạng (Top 5)</h3>
    <ol id="leaderboard-list"></ol>
  </div>

  <script>
    const board = document.getElementById("board");
    const blockOptions = document.getElementById("block-options");
    const leaderboardList = document.getElementById("leaderboard-list");
    const gridSize = 8;
    let grid = Array(gridSize * gridSize).fill(0);
    let blocks = [];
    let selectedBlock = null;
    let score = 0;

    const blockTemplates = [
      [[1, 1, 0], [1, 1, 0], [0, 0, 0]],
      [[1, 1, 1], [0, 0, 0], [0, 0, 0]],
      [[1, 0, 0], [1, 0, 0], [1, 0, 0]],
      [[0, 1, 0], [1, 1, 1], [0, 0, 0]],
      [[1, 1, 1], [1, 0, 0], [0, 0, 0]],
      [[0, 1, 1], [1, 1, 0], [0, 0, 0]],
    ];

    function renderBoard() {
      board.innerHTML = "";
      for (let i = 0; i < gridSize * gridSize; i++) {
        const cell = document.createElement("div");
        cell.className = "cell";
        if (grid[i] === 1) cell.classList.add("filled");
        cell.dataset.index = i;
        cell.addEventListener("click", () => placeBlock(i));
        board.appendChild(cell);
      }
    }

    function generateRandomBlocks() {
      blocks = [];
      for (let i = 0; i < 3; i++) {
        const block = blockTemplates[Math.floor(Math.random() * blockTemplates.length)];
        blocks.push(block.map(row => [...row]));
      }
    }

    function renderBlocks() {
      blockOptions.innerHTML = "";
      blocks.forEach((block, i) => {
        const div = document.createElement("div");
        div.className = "block";
        if (selectedBlock === i) div.classList.add("selected");
        block.flat().forEach(val => {
          const cell = document.createElement("div");
          cell.className = "block-cell";
          if (val === 1) cell.classList.add("filled");
          else cell.style.visibility = "hidden";
          div.appendChild(cell);
        });
        div.addEventListener("click", () => {
          selectedBlock = i;
          renderBlocks();
        });
        blockOptions.appendChild(div);
      });
    }

    function placeBlock(index) {
      if (selectedBlock === null) return;
      const row = Math.floor(index / gridSize);
      const col = index % gridSize;
      const block = blocks[selectedBlock];

      for (let i = 0; i < 3; i++) {
        for (let j = 0; j < 3; j++) {
          if (block[i][j] === 0) continue;
          const r = row + i;
          const c = col + j;
          if (r >= gridSize || c >= gridSize || grid[r * gridSize + c] === 1) return;
        }
      }

      for (let i = 0; i < 3; i++) {
        for (let j = 0; j < 3; j++) {
          if (block[i][j] === 1) {
            const r = row + i;
            const c = col + j;
            grid[r * gridSize + c] = 1;
          }
        }
      }

      blocks.splice(selectedBlock, 1);
      selectedBlock = null;
      renderBlocks();
      renderBoard();
      clearLines();

      if (blocks.length === 0) {
        generateRandomBlocks();
        renderBlocks();
      }

      if (!canPlaceAnyBlock()) {
        document.getElementById("game-over").style.display = "block";
        saveToLeaderboard(score);
        renderLeaderboard();
      }
    }

    function clearLines() {
      const rows = [], cols = [];

      for (let r = 0; r < gridSize; r++) {
        if (grid.slice(r * gridSize, (r + 1) * gridSize).every(v => v === 1)) rows.push(r);
      }

      for (let c = 0; c < gridSize; c++) {
        let full = true;
        for (let r = 0; r < gridSize; r++) {
          if (grid[r * gridSize + c] === 0) full = false;
        }
        if (full) cols.push(c);
      }

      if (rows.length === 0 && cols.length === 0) return;

      rows.forEach(r => {
        for (let c = 0; c < gridSize; c++) {
          const cell = board.children[r * gridSize + c];
          cell.classList.add("highlight");
        }
      });

      cols.forEach(c => {
        for (let r = 0; r < gridSize; r++) {
          const cell = board.children[r * gridSize + c];
          cell.classList.add("highlight");
        }
      });

      setTimeout(() => {
        rows.forEach(r => {
          for (let c = 0; c < gridSize; c++) {
            const idx = r * gridSize + c;
            grid[idx] = 0;
            board.children[idx].classList.add("shrink");
          }
        });

        cols.forEach(c => {
          for (let r = 0; r < gridSize; r++) {
            const idx = r * gridSize + c;
            grid[idx] = 0;
            board.children[idx].classList.add("shrink");
          }
        });

        score += (rows.length + cols.length) * 10;
        setTimeout(() => {
          renderBoard();
          document.getElementById("score").textContent = score;
        }, 350);
      }, 400);
    }

    function canPlaceAnyBlock() {
      for (const block of blocks) {
        for (let r = 0; r <= gridSize - 3; r++) {
          for (let c = 0; c <= gridSize - 3; c++) {
            if (canPlaceAt(block, r, c)) return true;
          }
        }
      }
      return false;
    }

    function canPlaceAt(block, row, col) {
      for (let i = 0; i < 3; i++) {
        for (let j = 0; j < 3; j++) {
          if (block[i][j] === 0) continue;
          const r = row + i;
          const c = col + j;
          if (r >= gridSize || c >= gridSize || grid[r * gridSize + c] === 1) return false;
        }
      }
      return true;
    }

    function restartGame() {
      grid = Array(gridSize * gridSize).fill(0);
      score = 0;
      selectedBlock = null;
      document.getElementById("game-over").style.display = "none";
      generateRandomBlocks();
      renderBoard();
      renderBlocks();
      document.getElementById("score").textContent = score;
    }

    function saveToLeaderboard(newScore) {
      const name = document.getElementById("player-name").value.trim() || "Người chơi";
      let leaderboard = JSON.parse(localStorage.getItem("blockblast_leaderboard") || "[]");
      leaderboard.push({ name, score: newScore });
      leaderboard.sort((a, b) => b.score - a.score);
      leaderboard = leaderboard.slice(0, 5);
      localStorage.setItem("blockblast_leaderboard", JSON.stringify(leaderboard));
    }

    function renderLeaderboard() {
      const leaderboard = JSON.parse(localStorage.getItem("blockblast_leaderboard") || "[]");
      leaderboardList.innerHTML = leaderboard
        .map((entry, i) => `<li>#${i + 1}: ${entry.name} - ${entry.score} điểm</li>`)
        .join("");
    }

    // Init
    generateRandomBlocks();
    renderBoard();
    renderBlocks();
    renderLeaderboard();
  </script>
</body>
</html>
